<link rel="import" href="../../bower_components/polymer/polymer.html"/><link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html"/><link rel="import" href="../../bower_components/iron-meta/iron-meta.html"/><link rel="import" href="../../bower_components/iron-signals/iron-signals.html"/><link rel="import" href="../../bower_components/glad-prelude-ls/glad-prelude-ls.html"/><dom-module id="glad-resource"><template><iron-meta id="meta" type="[[_meta_type]]"></iron-meta><iron-signals id="signals"></iron-signals></template></dom-module><script>(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
// Generated by LiveScript 1.4.0
var ref$, id, reject, filter, find, objToPairs, each, elemIndex, map, last, pairsToObj, elms, Resource, GladResource, x$;
ref$ = Polymer.GladPreludeLs, id = ref$.id, reject = ref$.reject, filter = ref$.filter, find = ref$.find, objToPairs = ref$.objToPairs, each = ref$.each, elemIndex = ref$.elemIndex, map = ref$.map, last = ref$.last, pairsToObj = ref$.pairsToObj;
elms = {};
Resource = (function(){
  Resource.displayName = 'Resource';
  var prototype = Resource.prototype, constructor = Resource;
  function Resource(){}
  return Resource;
}());
Polymer(
function(it){
  return it.prototype;
}(
GladResource = (function(){
  GladResource.displayName = 'GladResource';
  var prototype = GladResource.prototype, constructor = GladResource;
  prototype.is = 'glad-resource';
  prototype.listeners = {
    fetched: '_fire_changed',
    changed: 'set_instances'
  };
  Object.defineProperty(prototype, '_new_ajax', {
    get: function(){
      return document.createElement('iron-ajax');
    },
    configurable: true,
    enumerable: true
  });
  Object.defineProperty(prototype, '_elms', {
    get: function(){
      var key$;
      return elms[key$ = this._namespace] || (elms[key$] = []);
    },
    configurable: true,
    enumerable: true
  });
  Object.defineProperty(prototype, '_same_key_elms', {
    get: function(){
      var this$ = this;
      return filter(function(it){
        return it._meta_key === this$._meta_key;
      })(
      this._elms);
    },
    configurable: true,
    enumerable: true
  });
  Object.defineProperty(prototype, '_instances', {
    get: function(){
      return this._get_meta("instances-" + this._meta_key);
    },
    configurable: true,
    enumerable: true
  });
  Object.defineProperty(prototype, '_iron_request_to_fetch', {
    get: function(){
      return this._get_meta("iron-request-to-fetch-" + this._meta_key);
    },
    configurable: true,
    enumerable: true
  });
  Object.defineProperty(prototype, '_url_to_fetch', {
    get: function(){
      return this.domHost.url;
    },
    configurable: true,
    enumerable: true
  });
  Object.defineProperty(prototype, '_url_to_persist', {
    get: function(){
      return this.domHost.url;
    },
    configurable: true,
    enumerable: true
  });
  prototype._url_to_update = function(instance){
    return this.domHost.url + "/" + instance.id;
  };
  prototype._url_to_delete = function(instance){
    return this.domHost.url + "/" + instance.id;
  };
  Object.defineProperty(prototype, '_params_to_fetch', {
    get: function(){
      return this.domHost.params;
    },
    configurable: true,
    enumerable: true
  });
  Object.defineProperty(prototype, '_meta_key', {
    get: function(){
      return this._namespace + "-" + (this.domHost.meta_key || '$');
    },
    configurable: true,
    enumerable: true
  });
  Object.defineProperty(prototype, '_namespace', {
    get: function(){
      return this.domHost.namespace;
    },
    configurable: true,
    enumerable: true
  });
  prototype._get_meta = function(key){
    return this.$.meta.byKey(key);
  };
  prototype._set_meta = function(key, value){
    return this.$.meta._registerKeyValue(key, value);
  };
  prototype._let_signal_listen = function(){
    var this$ = this;
    return each(function(event_name){
      return this$.listen(this$.$.signals, "iron-signal-resource-" + this$._namespace + "-" + event_name, "_listener_for_" + event_name);
    })(
    ['fetched', 'changed']);
  };
  prototype._listener_for_fetched = function(_, arg$){
    var key;
    key = arg$.key;
    if (key !== this._meta_key) {
      return;
    }
    return this.fire('fetched', {
      instances: this._instances,
      host: this.domHost
    });
  };
  prototype._listener_for_changed = function(_, arg$){
    var key;
    key = arg$.key;
    if (key !== this._meta_key) {
      return;
    }
    return this.fire('changed', {
      instances: this._instances,
      host: this.domHost
    });
  };
  prototype._set_meta_type = function(){
    return this.set('_meta_type', "glad-resource-" + this._namespace);
  };
  prototype._fire_changed = function(){
    return this.fire('changed');
  };
  prototype._instantiate = function(seed){
    return new this.domHost.resource_class(seed);
  };
  prototype._fetch = function(cb){
    var x$, ajax, this$ = this;
    if (this._iron_request_to_fetch != null) {
      return;
    }
    x$ = ajax = this._new_ajax;
    x$.set('method', 'GET');
    x$.set('url', this._url_to_fetch);
    x$.set('params', this._params_to_fetch);
    (function(it){
      it.cb = cb;
      it.ajax = ajax;
      return this$._set_meta("iron-request-to-fetch-" + this$._meta_key, it);
    })(
    x$.generateRequest());
    return this.listen(ajax, 'response', '_complete_to_fetch');
  };
  prototype._complete_to_fetch = function(_, arg$){
    var cb, ajax;
    cb = arg$.cb, ajax = arg$.ajax;
    this._set_meta("instances-" + this._meta_key, map(bind$(this, '_instantiate'))(
    ajax.lastResponse));
    this.fire('iron-signal', {
      name: "resource-" + this._namespace + "-fetched",
      data: {
        key: this._meta_key
      }
    });
    return this._set_meta("iron-request-to-fetch-" + this._meta_key, undefined);
  };
  prototype._save = function(instance, cb){
    switch (false) {
    case instance.id != null:
      return this._persist.apply(this, arguments);
    default:
      return this._update.apply(this, arguments);
    }
  };
  prototype._persist = function(instance, cb){
    var x$, ajax;
    if (instance.constructor !== this.domHost.resource_class) {
      instance = this._create(instance);
    }
    x$ = ajax = this._new_ajax;
    x$.set('method', 'POST');
    x$.set('url', this._url_to_persist);
    x$.set('contentType', "application/json");
    x$.set('body', instance);
    (function(it){
      it.cb = cb;
      it.instance = instance;
      return it.ajax = ajax;
    })(
    x$.generateRequest());
    return this.listen(ajax, 'response', '_complete_to_persist');
  };
  prototype._complete_to_persist = function(_, arg$){
    var cb, instance, ajax;
    cb = arg$.cb, instance = arg$.instance, ajax = arg$.ajax;
    if (this._instances == null) {
      if (typeof cb == 'function') {
        cb(null, instance);
      }
      return;
    }
    this._set_meta("instances-" + this._meta_key, this._instances.concat(import$(instance, ajax.lastResponse)));
    this.fire('iron-signal', {
      name: "resource-" + this._namespace + "-changed",
      data: {
        key: this._meta_key
      }
    });
    return typeof cb == 'function' ? cb(null, instance) : void 8;
  };
  prototype._update = function(instance, cb){
    var x$, ajax;
    x$ = ajax = this._new_ajax;
    x$.set('method', 'PUT');
    x$.set('url', this._url_to_update(instance));
    x$.set('contentType', "application/json");
    x$.set('body', instance);
    (function(it){
      it.cb = cb;
      it.instance = instance;
      return it.ajax = ajax;
    })(
    x$.generateRequest());
    return this.listen(ajax, 'response', '_complete_to_update');
  };
  prototype._complete_to_update = function(_, arg$){
    var cb, instance, ajax, this$ = this;
    cb = arg$.cb, instance = arg$.instance, ajax = arg$.ajax;
    this._set_meta("instances-" + this._meta_key, map(function(it){
      if (it === instance) {
        return this$._instantiate(import$(instance, ajax.lastResponse));
      } else {
        return it;
      }
    })(
    this._instances));
    this.fire('iron-signal', {
      name: "resource-" + this._namespace + "-changed",
      data: {
        key: this._meta_key
      }
    });
    return typeof cb == 'function' ? cb(null, instance) : void 8;
  };
  prototype._delete = function(instance, cb){
    var x$, ajax;
    x$ = ajax = this._new_ajax;
    x$.set('method', 'DELETE');
    x$.set('url', this._url_to_delete(instance));
    x$.set('contentType', "application/json");
    x$.set('body', instance);
    (function(it){
      it.cb = cb;
      it.instance = instance;
      return it.ajax = ajax;
    })(
    x$.generateRequest());
    return this.listen(ajax, 'response', '_complete_to_delete');
  };
  prototype._complete_to_delete = function(_, arg$){
    var cb, instance, ajax;
    cb = arg$.cb, instance = arg$.instance, ajax = arg$.ajax;
    this._set_meta("instances-" + this._meta_key, reject(curry$(function(x$, y$){
      return x$ === y$;
    })(instance))(
    this._instances));
    this.fire('iron-signal', {
      name: "resource-" + this._namespace + "-changed",
      data: {
        key: this._meta_key
      }
    });
    return typeof cb == 'function' ? cb(null, instance) : void 8;
  };
  prototype._set_instances = function(){
    var this$ = this;
    return this.debounce('set_instances', function(){
      this$.domHost.set('instances', this$._instances);
      if (this$.domHost.instances == null) {
        return this$.fetch();
      }
    }, 100);
  };
  prototype._create = function(){
    var _class;
    return new ((_class = this.domHost.resource_class).bind.apply(_class, [_class].concat(map(id)(
    arguments))));
  };
  prototype.fetch = function(){
    return this._fetch.apply(this, arguments);
  };
  prototype.save = function(){
    return this._save.apply(this, arguments);
  };
  prototype.persist = function(){
    return this._persist.apply(this, arguments);
  };
  prototype.update = function(){
    return this._update.apply(this, arguments);
  };
  prototype['delete'] = function(){
    return this._delete.apply(this, arguments);
  };
  prototype.set_instances = function(){
    return this._set_instances.apply(this, arguments);
  };
  prototype.create = function(){
    return this._create.apply(this, arguments);
  };
  prototype.attached = function(){
    var key$;
    this._set_meta_type();
    (elms[key$ = this._namespace] || (elms[key$] = [])).push(this);
    this._let_signal_listen();
    if (this.domHost.autoFetch) {
      return this.set_instances();
    }
  };
  function GladResource(){
    this._complete_to_delete = bind$(this, '_complete_to_delete', prototype);
    this._complete_to_update = bind$(this, '_complete_to_update', prototype);
    this._complete_to_fetch = bind$(this, '_complete_to_fetch', prototype);
  }
  return GladResource;
}())));
x$ = Polymer.GladResourceUserBehavior = {};
x$.properties = {
  autoFetch: {
    value: true
  },
  instances: {
    type: Array,
    notify: true
  }
};
import$(x$, pairsToObj(
map(function(method_name){
  return [
    method_name, function(){
      var elm;
      return (elm = this.$$('glad-resource'))[method_name].apply(elm, arguments);
    }
  ];
})(
['fetch', 'save', 'persist', 'update', 'delete', 'set_instances', 'create'])));
function bind$(obj, key, target){
  return function(){ return (target || obj)[key].apply(obj, arguments) };
}
function import$(obj, src){
  var own = {}.hasOwnProperty;
  for (var key in src) if (own.call(src, key)) obj[key] = src[key];
  return obj;
}
function curry$(f, bound){
  var context,
  _curry = function(args) {
    return f.length > 1 ? function(){
      var params = args ? args.concat() : [];
      context = bound ? context || this : this;
      return params.push.apply(params, arguments) <
          f.length && arguments.length ?
        _curry.call(context, params) : f.apply(context, params);
    } : f;
  };
  return _curry();
}



},{}]},{},[1]);
</script>